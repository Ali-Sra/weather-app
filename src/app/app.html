<div class="container">
  <!-- Header / Search -->
  <header class="topbar">
    <h1>Weather</h1>
    <div class="searchbar">
      <input
        list="cityHints"
        [(ngModel)]="query"
        (keyup.enter)="search()"
        placeholder="City or City,CC (e.g. Hamburg,DE)"
        aria-label="Search city" />
      <datalist id="cityHints">
        <option *ngFor="let h of hints" [value]="formatHint(h)"></option>
      </datalist>

      <select [(ngModel)]="units" (change)="search()" aria-label="Units">
        <option value="metric">°C</option>
        <option value="imperial">°F</option>
        <option value="standard">K</option>
      </select>

      <button (click)="search()">Search</button>

      <label class="lang">
        <span>Lang:</span>
        <select [(ngModel)]="lang" (change)="search()">
          <option value="en">en</option>
          <option value="fa">fa</option>
          <option value="de">de</option>
          <option value="tr">tr</option>
          <option value="ar">ar</option>
        </select>
      </label>
    </div>
  </header>

  <!-- Loading / Error -->
  <p *ngIf="svc.loading()" class="muted">در حال دریافت…</p>
  <p *ngIf="svc.error()" class="error">{{ svc.error() }}</p>

  <!-- Current Card -->
  <section *ngIf="svc.current()" class="card current-card">
    <div class="current-left">
      <img *ngIf="svc.current().weather?.[0]?.icon"
           [src]="'https://openweathermap.org/img/wn/' + svc.current().weather[0].icon + '@2x.png'"
           alt="">
      <div>
        <h2 style="margin:.25rem 0">
          {{ svc.current().name }} <small>({{ svc.current().sys?.country }})</small>
        </h2>
        <small class="muted">
          آخرین به‌روزرسانی: {{ toCityDate(svc.current().dt) | date:'EEE d MMM, HH:mm' }}
        </small>
        <div style="font-size:2rem; font-weight:700; margin-top:.5rem">
          {{ svc.current().main?.temp | number:'1.0-2' }} {{ unitSymbol() }}
        </div>
        <div class="muted">{{ svc.current().weather?.[0]?.description }}</div>
      </div>
    </div>

    <ul class="facts">
      <li>Feels: <b>{{ svc.current().main?.feels_like }} {{ unitSymbol() }}</b></li>
      <li>Humidity: <b>{{ svc.current().main?.humidity }}%</b></li>
      <li>Pressure: <b>{{ svc.current().main?.pressure }} hPa</b></li>
      <li>Visibility: <b>{{ (svc.current().visibility ?? 0)/1000 | number:'1.0-1' }} km</b></li>
      <li>Wind:
        <b>{{ svc.current().wind?.speed }} {{ units==='imperial' ? 'mph' : 'm/s' }}</b>
        <span class="arrow" [style.transform]="'rotate(' + windDeg() + 'deg)'"></span>
        <small>({{ svc.current().wind?.deg }}°)</small>
      </li>
      <li>Sunrise: <b>{{ toCityDate(svc.current().sys?.sunrise) | date:'HH:mm' }}</b></li>
      <li>Sunset: <b>{{ toCityDate(svc.current().sys?.sunset) | date:'HH:mm' }}</b></li>
    </ul>

    <div class="aqi-pill" *ngIf="svc.aqi() as x" [style.background]="aqiColor(x)">
      AQI: {{ x }} · {{ aqiLabel(x) }}
    </div>
  </section>

  <!-- Tabs (visible when OneCall exists) -->
  <section *ngIf="svc.onecall()" class="tabs card">
    <nav class="tabbar">
      <button [class.active]="tab==='hourly'" (click)="tab='hourly'">۲۴ ساعت آینده</button>
      <button [class.active]="tab==='daily'" (click)="tab='daily'">۷ روز آینده</button>
      <button [class.active]="tab==='alerts'" (click)="tab='alerts'">هشدارها</button>
      <button [class.active]="tab==='map'" (click)="openMapTab()">نقشه</button>
      <button [class.active]="tab==='minutely'" (click)="onOpenMinutely()">دقیقه‌ای</button>
      <button [class.active]="tab==='history'" (click)="openHistoryTab()">تاریخی</button>
      <button [class.active]="tab==='summary'" (click)="openSummaryTab()">خلاصه روز</button>
      <button [class.active]="tab==='overview'" (click)="openOverviewTab()">Overview (AI)</button>
      <button [class.active]="tab==='assistant'" (click)="openAssistantTab()">Assistant 🤖</button>
    </nav>

    <!-- Hourly -->
    <div *ngIf="tab==='hourly'" class="hours">
      <div class="hour" *ngFor="let h of next24()">
        <div class="time">{{ toCityDate(h.dt) | date:'HH:mm' }}</div>
        <img [src]="'https://openweathermap.org/img/wn/' + h.weather[0].icon + '.png'" alt="">
        <div class="t">{{ h.temp | number:'1.0-0' }} {{ unitSymbol() }}</div>
        <div class="pop" *ngIf="h.pop != null">💧 {{ (h.pop*100) | number:'1.0-0' }}%</div>
        <div class="w">🌬 {{ h['wind_speed'] | number:'1.0-0' }} {{ units==='imperial' ? 'mph' : 'm/s' }}</div>
      </div>
    </div>

    <!-- Daily -->
    <div *ngIf="tab==='daily'" class="days">
      <div class="day" *ngFor="let d of svc.onecall().daily">
        <div class="date">{{ toCityDate(d.dt) | date:'EEE d MMM' }}</div>
        <img [src]="'https://openweathermap.org/img/wn/' + d.weather[0].icon + '.png'" alt="">
        <div class="t"><b>{{ d.temp.max | number:'1.0-0' }}°</b> / {{ d.temp.min | number:'1.0-0' }}°</div>
        <div class="pop" *ngIf="d.pop != null">💧 {{ (d.pop*100) | number:'1.0-0' }}%</div>
      </div>
    </div>

    <!-- Alerts -->
    <div *ngIf="tab==='alerts'">
      <p *ngIf="!svc.onecall().alerts?.length" class="muted">هشداری وجود ندارد.</p>
      <div class="alert" *ngFor="let a of svc.onecall().alerts">
        <h4>{{ a.event }}</h4>
        <small class="muted">
          {{ toCityDate(a.start) | date:'EEE d MMM, HH:mm' }} – {{ toCityDate(a.end) | date:'EEE d MMM, HH:mm' }}
        </small>
        <p>{{ a.description }}</p>
        <div class="muted">Source: {{ a.sender_name }}</div>
      </div>
    </div>

    <!-- Map -->
    <div *ngIf="tab==='map'" class="map-wrap">
      <div class="map-toolbar">
        <label>Layer:</label>
        <select [(ngModel)]="layer" (change)="onLayerChange()">
          <option *ngFor="let l of LAYERS" [value]="l.id">{{ l.label }}</option>
        </select>
      </div>
      <div id="map" class="map"></div>
    </div>

    <!-- Minutely -->
    <div *ngIf="tab==='minutely'" class="hours">
      <p *ngIf="!minuteLoaded()" class="muted">در حال دریافت…</p>
      <div class="hour" *ngFor="let m of svc.minute()">
        <div>{{ toCityDate(m.dt) | date:'HH:mm' }}</div>
        <div>💧 {{ m.precipitation | number:'1.0-2' }} mm/h</div>
      </div>
      <p *ngIf="minuteLoaded() && (!svc.minute() || !svc.minute()!.length)" class="muted">داده‌ای نیست.</p>
    </div>

    <!-- History -->
    <div *ngIf="tab==='history'">
      <div class="searchbar" style="margin:.5rem 0">
        <input type="date" [(ngModel)]="historyDate">
        <input type="time" [(ngModel)]="historyTime">
        <button (click)="onLoadHistory()">نمایش</button>
      </div>
      <div *ngIf="svc.history() as H" class="hours">
        <div class="hour" *ngFor="let d of H.data">
          <div>{{ toCityDate(d.dt) | date:'EEE d MMM, HH:mm' }}</div>
          <div>🌡 {{ d.temp | number:'1.0-1' }} {{ unitSymbol() }}</div>
          <div>💨 {{ d.wind_speed | number:'1.0-1' }} {{ units==='imperial' ? 'mph' : 'm/s' }}</div>
          <div>☁️ {{ d.clouds }}%</div>
          <div>{{ d.weather?.[0]?.description }}</div>
        </div>
      </div>
    </div>

    <!-- Day Summary -->
    <div *ngIf="tab==='summary'">
      <div class="searchbar" style="margin:.5rem 0">
        <input type="date" [(ngModel)]="summaryDate">
        <input placeholder="+02:00 (اختیاری)" [(ngModel)]="summaryTz" style="width:120px">
        <button (click)="onLoadDaySummary()">نمایش</button>
      </div>
      <div *ngIf="svc.daySummary() as S" class="days">
        <div class="day"><b>Min/Max</b>
          <div>{{ S.temperature?.min | number:'1.0-1' }} / {{ S.temperature?.max | number:'1.0-1' }} {{ unitSymbol() }}</div>
        </div>
        <div class="day"><b>12:00</b><div>{{ S.temperature?.afternoon }} {{ unitSymbol() }}</div></div>
        <div class="day"><b>Humidity</b><div>{{ S.humidity?.afternoon }}%</div></div>
        <div class="day"><b>Pressure</b><div>{{ S.pressure?.afternoon }} hPa</div></div>
        <div class="day"><b>Clouds</b><div>{{ S.cloud_cover?.afternoon }}%</div></div>
        <div class="day"><b>Precip</b><div>{{ S.precipitation?.total }} mm</div></div>
        <div class="day"><b>Wind Max</b>
          <div>{{ S.wind?.max?.speed }} {{ units==='imperial' ? 'mph' : 'm/s' }} ({{ S.wind?.max?.direction }}°)</div>
        </div>
      </div>
    </div>

    <!-- Overview (AI) -->
    <div *ngIf="tab==='overview'">
      <p *ngIf="!svc.overview()" class="muted">در حال دریافت…</p>
      <pre *ngIf="svc.overview()" style="white-space:pre-wrap">{{ svc.overview() }}</pre>
    </div>

    <!-- Assistant -->
    <div *ngIf="tab==='assistant'">
      <h3>AI Weather Assistant</h3>
      <div class="searchbar" style="margin:.5rem 0">
        <input [(ngModel)]="assistantInput" placeholder="Ask about the weather…" style="flex:1">
        <button (click)="onAssistantSend()">Send</button>
      </div>
      <div *ngFor="let m of assistantLog" class="chat-bubble" [class.me]="m.role==='you'">
        <b>{{ m.role==='you' ? 'You' : 'Assistant' }}</b>
        <div>{{ m.text }}</div>
      </div>
    </div>
  </section>
</div>
